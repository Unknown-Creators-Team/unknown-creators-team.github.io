<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Unknown</title>
        <link rel="icon" href="/images/unknown-icon.webp">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

        <!-- <style>
            body {
                background-color: #cacaca;
                text-align: center;
            }

            img {
                width: 128px;
                height: 128px;
                border-radius: 50%;
            }
        </style> -->
    </head>

    <body>

        <div id="main">
            <h3>処理中...</h3>
        </div>

        <script>
            const API_ENDPOINT = 'https://discord.com/api/v10'
            const CLIENT_ID = '1134773310127878274'
            const CLIENT_SECRET = 'mq-4uMfHlixM0rTaODV4Cfq92B2gfxrh'
            const REDIRECT_URI = `${location.protocol}//${location.hostname}${location.port ? `:${location.port}` : ''}/login.html`
            
            class Cookie extends Map {
                constructor() {
                    super();
                    document.cookie.split(';').forEach(cookie => {
                        const [key, value] = cookie.split('=');
                        this.set(key.trim(), value);
                    });
                }
                set(key, value, expire = 0) {
                    if (typeof value === 'object') value = JSON.stringify(value);
                    super.set(key, value);
                    document.cookie = `${key}=${value};${expire ? `expires=${new Date(Date.now() + expire * 1000).toUTCString()};` : ''}path=/;`;
                }
                get(key) {
                    let value = super.get(key);
                    return isJson(value) ? JSON.parse(value) : value;
                }
                delete(key) {
                    super.delete(key);
                    document.cookie = `${key}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;`;
                }
            }
            
            const cookie = new Cookie();

            const params = new URLSearchParams(window.location.search);

            if (params.has("redirect")) {
                console.log("href", window.location.href);
                console.log("redirect", window.location.search.replace("?redirect=", "").replace("=", ":-:"));
                console.log("redirect", params.get("redirect"));
                if (!params.get("redirect")) window.location.href = "/";
                cookie.set("redirect", window.location.search.replace("?redirect=", "").replace("=", ":-:"), 60 * 60);
            }

            if (params.has("code") || cookie.has("token")) {
                const code = params.get('code');
                const token = cookie.get("token")?.access_token;
                
                if (token) {
                    getFromToken(token).then(json => {
                        refreshToken(cookie.get("token")).then(json => {
                            cookie.set("token", json, json.expires_in * 9 / 10);
                            backToPage();
                        }).fail(() => {
                            cookie.delete("token");
                            login();
                        });
                    })
                    .fail(() => {
                        cookie.delete("token");
                        login();
                    })
                } else if (code) {
                    getToken(code).then(json => {
                        cookie.set("token", json, json.expires_in * 9 / 10);
                        getFromToken(json.access_token).then(json => {
                            backToPage();
                        });
                    }).fail(json => login());
                } else setTimeout(() => {
                    login();
                }, 0);
            } else {
                $("h3").text("リダイレクト中...");
                setTimeout(() => {
                    login();
                }, 0);
                
            }

            function login() {
                const host = window.location.hostname;
                if (host === "127.0.0.1") {
                    window.location.href = "https://discord.com/api/oauth2/authorize?client_id=1134773310127878274&redirect_uri=http%3A%2F%2F127.0.0.1%3A5500%2Flogin.html&response_type=code&scope=identify%20guilds";
                } else if (host == "192.168.1.45") {
                    window.location.href = "https://discord.com/api/oauth2/authorize?client_id=1134773310127878274&redirect_uri=http%3A%2F%2F192.168.1.45%3A5500%2Flogin.html&response_type=code&scope=identify%20guilds";
                } else if (host == "dev.un-known.xyz") {
                    window.location.href = "https://discord.com/api/oauth2/authorize?client_id=1134773310127878274&redirect_uri=http%3A%2F%2Fdev.un-known.xyz%3A5500%2Flogin.html&response_type=code&scope=identify%20guilds";
                } else if (host == "www.un-known.xyz") {
                    window.location.href = "https://discord.com/api/oauth2/authorize?client_id=1134773310127878274&redirect_uri=https%3A%2F%2Fwww.un-known.xyz%2Flogin.html&response_type=code&scope=identify%20guilds";
                }
            }

            function getToken(code) {
                const deferred = $.Deferred();

                const body = {
                    'client_id': CLIENT_ID,
                    'client_secret': CLIENT_SECRET,
                    'grant_type': 'authorization_code',
                    'code': code,
                    'redirect_uri': REDIRECT_URI
                }
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }

                const data = {method: 'POST', body: encode(body), headers: headers}
                
                fetch(`${API_ENDPOINT}/oauth2/token`, data)
                .then(response => response.json())
                .then(json => {
                    $("h3").text("ログインしました");
                    if (!json.error) deferred.resolve(json);
                        else deferred.reject(json);
                });

                return deferred.promise();
            }

            function refreshToken(json) {
                const deferred = $.Deferred();
                fetch('https://discordapp.com/api/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}&grant_type=refresh_token&refresh_token=${json.refresh_token}`
                })
                .then(response => response.json())
                .then(json => {

                    if (!json.error) deferred.resolve(json);
                        else deferred.reject(json);
                });

                return deferred.promise();
            }

            function getFromToken(token) {
                const deferred = $.Deferred();

                fetch('https://discordapp.com/api/users/@me', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(response => response.json())
                .then(json => {
                    // $("h1").text("ログインしました。");
                    // $("#show").append(`<img src="https://cdn.discordapp.com/avatars/${json.id}/${json.avatar}.png">`);
                    // $("#show").append(`<h2>${json.global_name}</h2>`);
                    
                    return deferred.resolve(json);
                })

                return deferred.promise();
            }

            function backToPage() {
                setTimeout(() => {
                    if (cookie.has("redirect")) {
                        const redirect = cookie.get("redirect");
                        cookie.delete("redirect");
                        window.location.href = redirect.replace(":-:", "=");
                    } else window.location.href = "/";
                }, 0);
            }

            function encode (obj) {
                return Object.keys(obj).map(key => {
                    return encodeURIComponent(key) + '=' + encodeURIComponent(obj[key])
                }).join('&')
            }

            function isJson(data) {
                try {
                    JSON.parse(data);
                } catch (error) {
                    return false;
                }
                return true;
            }
        </script>

    </body>
</html>